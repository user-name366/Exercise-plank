<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مستكشف الوسائط</title>
  <style>
    /* ... (جميع أنماط CSS السابقة - لم تتغير) ... */
    :root {
      --primary: #6A5ACD;          /* أرجواني ملكي */
      --primary-dark: #4B0082;     /* نيلي غامق */
      --secondary: #20B2AA;        /* أخضر بحري */
      --accent: #FF6B6B;           /* وردي مرجاني */
      --light: #F8F9FF;            /* أزرق فاتح جداً */
      --dark: #2D3047;             /* أزرق غامق */
      --gray: #8A8D93;             /* رمادي */
      --light-gray: #E6E9F0;       /* رمادي فاتح */
      --card-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
      background: linear-gradient(135deg, #F5F7FA 0%, #E6E9F0 100%);
      color: var(--dark);
      line-height: 1.6;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .folder-input-container {
      position: relative;
    }

    .folder-input-label {
      background-color: rgba(255, 255, 255, 0.15);
      color: white;
      padding: 0.7rem 1.2rem;
      border-radius: 30px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
    }

    .folder-input-label:hover {
      background-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    #folderInput {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .tabs-container {
      background-color: white;
      position: sticky;
      top: 68px;
      z-index: 90;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid var(--light-gray);
    }

    .tabs {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      color: var(--gray);
      transition: var(--transition);
      position: relative;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--secondary);
    }

    .tab:hover {
      color: var(--primary-dark);
      background-color: var(--light);
    }

    .tab-badge {
      position: absolute;
      top: 6px;
      left: 6px;
      background-color: var(--accent);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .content-container {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .search-container {
      margin: 1.5rem 0;
      position: relative;
    }

    #searchInput {
      width: 100%;
      padding: 1rem 1.2rem;
      border: 1px solid var(--light-gray);
      border-radius: 12px;
      font-size: 1rem;
      background-color: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      transition: var(--transition);
    }

    #searchInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(106, 90, 205, 0.15);
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.8rem;
    }

    @media (max-width: 768px) {
      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1.2rem;
      }
      
      .content-container {
        padding: 1.2rem;
      }
    }

    .media-card {
      background-color: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .media-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
    }

    /* New styles for the post header */
    .media-header {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 1.2rem 1.2rem 0;
    }

    .publisher-avatar {
      width: 40px;
      height: 40px;
      background-color: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      color: white;
    }

    .publisher-info {
      flex-grow: 1;
    }

    .publisher-name {
      font-weight: 600;
      color: var(--dark);
    }

    .post-date {
      font-size: 0.8rem;
      color: var(--gray);
    }

    /* End of new styles */

    .media-thumbnail {
      position: relative;
      width: 100%;
      padding-top: 60%;
      background: linear-gradient(135deg, var(--light), var(--light-gray));
      overflow: hidden;
    }

    .media-thumbnail img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .media-thumbnail video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-card:hover .media-thumbnail img {
      transform: scale(1.05);
    }

    /* Style for the Play Icon in the video card */
    .play-icon-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      pointer-events: none; /* مهم للسماح بالضغط على البطاقة */
    }

    .play-icon-overlay .play-btn {
      width: 60px;
      height: 60px;
      background-color: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      border: 3px solid white;
      transition: transform 0.2s ease;
    }
    
    .media-card:hover .play-icon-overlay .play-btn {
      transform: scale(1.1);
    }
    /* End of Play Icon Style */


    .file-type-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background-color: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .audio-thumbnail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #6A5ACD, #4B0082);
      color: white;
      font-size: 2.5rem;
    }

    .doc-thumbnail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #20B2AA, #2D8E87);
      color: white;
      font-size: 2.5rem;
    }

    .media-info {
      padding: 1.2rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .media-title {
      font-weight: 600;
      margin-bottom: 0.3rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-meta {
      display: flex;
      justify-content: space-between;
      color: var(--gray);
      font-size: 0.85rem;
    }

    .media-type {
      text-transform: capitalize;
      background-color: var(--light);
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-weight: 500;
    }

    .media-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
      z-index: 200;
      transform: translateY(100%);
      transition: var(--transition);
      max-width: 1200px;
      margin: 0 auto;
      border-radius: 16px 16px 0 0;
      overflow: hidden;
    }

    .media-player.active {
      transform: translateY(0);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    .player-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .player-close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .player-content {
      padding: 1.5rem;
      max-height: 70vh;
      overflow: auto;
    }

    .player-content video, .player-content audio {
      width: 100%;
      border-radius: 8px;
    }

    .player-content img {
      max-width: 100%;
      max-height: 65vh;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .doc-viewer {
      width: 100%;
      height: 65vh;
      border: none;
      background-color: var(--light);
      border-radius: 8px;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 3rem;
    }

    .spinner {
      width: 44px;
      height: 44px;
      border: 4px solid rgba(106, 90, 205, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--gray);
      background-color: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      margin: 2rem 0;
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: var(--dark);
    }

    .empty-description {
      margin-bottom: 2rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .floating-action-btn {
      position: fixed;
      bottom: 2rem;
      left: 2rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 15px rgba(106, 90, 205, 0.3);
      cursor: pointer;
      z-index: 100;
      transition: var(--transition);
      font-size: 1.2rem;
      font-weight: bold;
    }

    .floating-action-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 10px 25px rgba(106, 90, 205, 0.4);
    }

    .alert-message {
      background: linear-gradient(to right, #FFF3E0, #FFE0B2);
      color: #E65100;
      padding: 1.2rem;
      border-radius: 12px;
      margin: 1.5rem auto;
      max-width: 800px;
      text-align: center;
      border-right: 5px solid #FF9800;
      box-shadow: 0 2px 8px rgba(230, 81, 0, 0.1);
    }

    /* Video Overlay Styles */
    #videoOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
    }

    .video-overlay-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    #overlayVideo {
      width: 90%;
      max-height: 85vh;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .video-controls {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .video-controls.hidden {
      opacity: 0;
    }

    .video-controls button {
      pointer-events: auto;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      background-color: rgba(106, 90, 205, 0.8);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .video-controls button:hover {
      background-color: rgba(106, 90, 205, 1);
      transform: scale(1.1);
    }

    .close-overlay-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 107, 107, 0.9) !important;
    }

    .prev-video-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .next-video-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .bottom-controls-group { /* New container for bottom buttons */
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      display: flex;
      gap: 15px; /* Spacing between buttons */
    }

    .autoplay-toggle-btn, .shuffle-toggle-btn {
      border-radius: 25px !important;
      width: auto !important;
      height: auto !important;
      padding: 0.7rem 1.5rem;
      font-size: 1rem !important;
      background-color: rgba(32, 178, 170, 0.8) !important; /* Secondary color for clarity */
    }

    .autoplay-toggle-btn:hover, .shuffle-toggle-btn:hover {
      background-color: rgba(32, 178, 170, 1) !important;
    }


    /* Image Overlay Styles */
    #imageOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      cursor: pointer;
    }

    .image-overlay-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    #overlayImage {
      max-width: 95%;
      max-height: 95vh;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      object-fit: contain;
    }

    .close-image-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 107, 107, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      z-index: 1001;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="header-content">
        <div class="logo">
          <span>📁</span>
          <span>مستكشف الوسائط</span>
        </div>
        <div class="folder-input-container">
          <label for="folderInput" class="folder-input-label">
            <span>📂</span>
            <span>اختر مجلد</span>
          </label>
          <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>
      </div>
    </header>

    <div class="tabs-container">
      <div class="tabs" id="tabs">
        <div class="tab active" data-type="all">
          <span>🏠 الرئيسية</span>
          <span class="tab-badge" id="all-badge"></span>
        </div>
        <div class="tab" data-type="image">
          <span>🖼️ الصور</span>
          <span class="tab-badge" id="image-badge"></span>
        </div>
        <div class="tab" data-type="video">
          <span>🎥 الفيديوهات</span>
          <span class="tab-badge" id="video-badge"></span>
        </div>
        <div class="tab" data-type="audio">
          <span>🎧 الصوتيات</span>
          <span class="tab-badge" id="audio-badge"></span>
        </div>
        <div class="tab" data-type="doc">
          <span>📄 المستندات</span>
          <span class="tab-badge" id="doc-badge"></span>
        </div>
      </div>
    </div>
    
    <div class="content-container">
      <div class="search-container">
        <input
          type="text"
          id="searchInput"
          placeholder="🔍 ابحث عن ملف بالاسم أو النوع..."
        />
      </div>
      
      <div class="alert-message" id="alertMessage">
        ⚠️ من فضلك اختر مجلدًا لبدء استعراض الملفات
      </div>
      
      <div class="media-grid" id="mediaGrid"></div>
      
      <div class="loading-spinner" id="loadingSpinner" style="display: none;">
        <div class="spinner"></div>
      </div>
      
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">📁</div>
        <h3 class="empty-title">لا توجد ملفات وسائط</h3>
        <p class="empty-description">اختر مجلدًا يحتوي على ملفات الوسائط الخاصة بك أو جرب البحث باستخدام كلمات أخرى</p>
        <label for="folderInput" class="folder-input-label">
          <span>📂</span>
          <span>اختر مجلد</span>
        </label>
      </div>
    </div>

    <div class="media-player" id="mediaPlayer">
      <div class="player-header">
        <div class="player-title" id="playerTitle"></div>
        <button class="player-close" id="playerClose">×</button>
      </div>
      <div class="player-content" id="playerContent"></div>
    </div>

    <div class="floating-action-btn" id="scrollToTop" title="الانتقال للأعلى" style="display: none;">
      ↑
    </div>
  </div>

  <div id="videoOverlay">
    <div class="video-overlay-content">
      <video id="overlayVideo" controls autoplay></video>
      
      <div class="video-controls" id="videoControls">
        <button class="close-overlay-btn" onclick="closeVideoOverlay()">✕</button>
        <button class="prev-video-btn" onclick="playPrevVideo()">⏮</button>
        <button class="next-video-btn" onclick="playNextVideo()">⏭</button>
        
        <div class="bottom-controls-group">
          <button class="autoplay-toggle-btn" onclick="toggleAutoPlay(event)">التشغيل التلقائي: غير مفعل</button>
          <button class="shuffle-toggle-btn" onclick="toggleShuffle(event)">الترتيب العشوائي: غير مفعل</button>
        </div>
      </div>
    </div>
  </div>

  <div id="imageOverlay">
    <div class="image-overlay-content">
      <img id="overlayImage" src="" alt="Full size image">
      <button class="close-image-btn" onclick="closeImageOverlay()">✕</button>
    </div>
  </div>

  <script>
    // App State
    const state = {
      files: [],
      currentTab: 'all',
      loadedFiles: new Set(),
      currentlyPlaying: null,
      isLoading: false,
      counts: {
        all: 0,
        image: 0,
        video: 0,
        audio: 0,
        doc: 0
      },
      // === التعديل هنا: إضافة خاصية تتبع التشغيل العشوائي ===
      shuffleEnabled: true, // تفعيل الترتيب العشوائي افتراضياً كما طلبت
      // ======================================================
      videoPlayList: [] // قائمة التشغيل العشوائية/المرتبة الحالية
    };

    // DOM Elements
    const elements = {
      folderInput: document.getElementById('folderInput'),
      tabs: document.getElementById('tabs'),
      searchInput: document.getElementById('searchInput'),
      mediaGrid: document.getElementById('mediaGrid'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      emptyState: document.getElementById('emptyState'),
      mediaPlayer: document.getElementById('mediaPlayer'),
      playerTitle: document.getElementById('playerTitle'),
      playerContent: document.getElementById('playerContent'),
      playerClose: document.getElementById('playerClose'),
      scrollToTop: document.getElementById('scrollToTop'),
      tabBadges: {
        all: document.getElementById('all-badge'),
        image: document.getElementById('image-badge'),
        video: document.getElementById('video-badge'),
        audio: document.getElementById('audio-badge'),
        doc: document.getElementById('doc-badge')
      },
      alertMessage: document.getElementById('alertMessage')
    };

    // Constants
    const BATCH_SIZE = 12;
    const SUPPORTED_FORMATS = {
      image: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'],
      video: ['mp4', 'webm', 'mov', 'avi', 'mkv', 'flv'],
      audio: ['mp3', 'wav', 'ogg', 'm4a', 'flac'],
      doc: ['pdf', 'doc', 'docx', 'txt', 'rtf', 'xls', 'xlsx', 'ppt', 'pptx']
    };

    // Utility function to shuffle an array
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // Initialize the app
    function init() {
      setupEventListeners();
      updateUI();
      showAlertMessage();
      updateShuffleButton(); // تحديث زر التشغيل العشوائي عند التهيئة
    }

    // Event Listeners
    function setupEventListeners() {
      // Folder selection
      elements.folderInput.addEventListener('change', handleFolderSelection);

      // Tab switching
      Array.from(elements.tabs.children).forEach(tab => {
        tab.addEventListener('click', () => {
          state.currentTab = tab.dataset.type;
          state.loadedFiles.clear();
          updateUI();
          renderMediaGrid();
        });
      });

      // Search functionality
      elements.searchInput.addEventListener('input', handleSearch);

      // Infinite scroll
      window.addEventListener('scroll', handleScroll);

      // Media player close
      elements.playerClose.addEventListener('click', closeMediaPlayer);

      // Scroll to top button
      elements.scrollToTop.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Show/hide scroll to top button
      window.addEventListener('scroll', () => {
        elements.scrollToTop.style.display = window.scrollY > 300 ? 'flex' : 'none';
      });
    }

    // Show alert message
    function showAlertMessage() {
      elements.alertMessage.style.display = 'block';
      elements.emptyState.style.display = 'none';
      elements.mediaGrid.innerHTML = '';
    }

    // Hide alert message
    function hideAlertMessage() {
      elements.alertMessage.style.display = 'none';
    }

    // Handle folder selection
    function handleFolderSelection(event) {
      const newFiles = Array.from(event.target.files)
        .filter(file => isSupportedFile(file.name))
        .map(file => ({
          file,
          id: generateFileId(file),
          type: getFileType(file.name),
          name: file.name,
          size: file.size,
          lastModified: file.lastModified
        }));

      // Add new files to the beginning of the array
      state.files = [...newFiles, ...state.files];
      updateFileCounts();
      
      // Reset loaded files for current tab
      state.loadedFiles.clear();
      
      hideAlertMessage();
      updateUI();
      renderMediaGrid();
    }

    // Handle search
    function handleSearch() {
      const query = elements.searchInput.value.toLowerCase();
      renderMediaGrid(query);
    }

    // Check if file is supported
    function isSupportedFile(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return Object.values(SUPPORTED_FORMATS).some(formats => formats.includes(ext));
    }

    // Get file type
    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      
      for (const [type, formats] of Object.entries(SUPPORTED_FORMATS)) {
        if (formats.includes(ext)) {
          return type;
        }
      }
      
      return 'other';
    }

    // Generate unique ID for file
    function generateFileId(file) {
      return `${file.name}-${file.size}-${file.lastModified}`;
    }

    // Update file type counts
    function updateFileCounts() {
      const counts = {
        all: state.files.length,
        image: 0,
        video: 0,
        audio: 0,
        doc: 0
      };

      state.files.forEach(file => {
        if (file.type === 'image') counts.image++;
        if (file.type === 'video') counts.video++;
        if (file.type === 'audio') counts.audio++;
        if (file.type === 'doc') counts.doc++;
      });

      state.counts = counts;
    }

    // Filter files based on current tab and search query
    function getFilteredFiles(query = '') {
      let filteredFiles = state.files;
      
      if (state.currentTab !== 'all') {
        filteredFiles = state.files.filter(file => file.type === state.currentTab);
      }
      
      if (query) {
        filteredFiles = filteredFiles.filter(file => 
          file.name.toLowerCase().includes(query) ||
          file.type.toLowerCase().includes(query) ||
          file.name.split('.').pop().toLowerCase().includes(query)
        );
      }
      
      if (state.currentTab === 'all') {
        // Shuffle for home tab but keep search results relevant
        return query ? filteredFiles : [...filteredFiles].sort(() => Math.random() - 0.5);
      }
      
      return filteredFiles;
    }

    // Render media grid
    function renderMediaGrid(query = '') {
      const filteredFiles = getFilteredFiles(query);
      
      if (filteredFiles.length === 0) {
        elements.emptyState.style.display = 'block';
        elements.mediaGrid.innerHTML = '';
        return;
      }
      
      elements.emptyState.style.display = 'none';
      elements.mediaGrid.innerHTML = '';
      state.loadedFiles.clear();
      loadMoreItems(query);
      
      // Note: Videos are shuffled on the fly when opening the overlay now
    }

    // Load more items (infinite scroll)
    function loadMoreItems(query = '') {
      if (state.isLoading) return;
      
      const filteredFiles = getFilteredFiles(query);
      const unloadedFiles = filteredFiles.filter(file => !state.loadedFiles.has(file.id));
      
      if (unloadedFiles.length === 0) return;
      
      state.isLoading = true;
      elements.loadingSpinner.style.display = 'flex';
      
      // Simulate loading delay for better UX
      setTimeout(() => {
        const batch = unloadedFiles.slice(0, BATCH_SIZE);
        
        batch.forEach(file => {
          state.loadedFiles.add(file.id);
          createMediaCard(file);
        });
        
        state.isLoading = false;
        elements.loadingSpinner.style.display = 'none';
      }, 300);
    }

    // Create media card
    function createMediaCard(file) {
      const card = document.createElement('div');
      card.className = 'media-card';
      card.dataset.id = file.id;
      
      // New: Post Header
      const header = document.createElement('div');
      header.className = 'media-header';
      
      const avatar = document.createElement('div');
      avatar.className = 'publisher-avatar';
      avatar.textContent = '👤';
      
      const publisherInfo = document.createElement('div');
      publisherInfo.className = 'publisher-info';
      
      const publisherName = document.createElement('div');
      publisherName.className = 'publisher-name';
      publisherName.textContent = 'مستخدم محلي'; // Fixed publisher name
      
      const postDate = document.createElement('div');
      postDate.className = 'post-date';
      postDate.textContent = 'الآن'; // Fixed date
      
      publisherInfo.appendChild(publisherName);
      publisherInfo.appendChild(postDate);
      header.appendChild(avatar);
      header.appendChild(publisherInfo);
      
      card.appendChild(header);

      // Thumbnail
      const thumbnail = document.createElement('div');
      thumbnail.className = 'media-thumbnail';
      
      // File type badge
      const typeBadge = document.createElement('div');
      typeBadge.className = 'file-type-badge';
      typeBadge.textContent = file.name.split('.').pop().toUpperCase();
      thumbnail.appendChild(typeBadge);
      
      // File type specific content
      if (file.type === 'image') {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file.file);
        img.alt = file.name;
        img.loading = 'lazy';
        thumbnail.appendChild(img);
      } 
      else if (file.type === 'video') {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file.file);
        video.muted = true;
        video.loop = true;
        video.playsInline = true;
        thumbnail.appendChild(video);
        
        // === التعديل هنا: إضافة أيقونة التشغيل للفيديو ===
        const playIcon = document.createElement('div');
        playIcon.className = 'play-icon-overlay';
        playIcon.innerHTML = '<div class="play-btn">▶</div>';
        thumbnail.appendChild(playIcon);
        // ===============================================
      } 
      else if (file.type === 'audio') {
        const audioThumb = document.createElement('div');
        audioThumb.className = 'audio-thumbnail';
        audioThumb.innerHTML = '🎵';
        thumbnail.appendChild(audioThumb);
      } 
      else if (file.type === 'doc') {
        const docThumb = document.createElement('div');
        docThumb.className = 'doc-thumbnail';
        
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'pdf') docThumb.innerHTML = '📄';
        else if (ext === 'doc' || ext === 'docx') docThumb.innerHTML = '📝';
        else if (ext === 'xls' || ext === 'xlsx') docThumb.innerHTML = '📊';
        else if (ext === 'ppt' || ext === 'pptx') docThumb.innerHTML = '📋';
        else docThumb.innerHTML = '📁';
        
        thumbnail.appendChild(docThumb);
      }
      
      card.appendChild(thumbnail);

      // Info
      const info = document.createElement('div');
      info.className = 'media-info';
      
      const title = document.createElement('div');
      title.className = 'media-title';
      title.textContent = file.name;
      
      const meta = document.createElement('div');
      meta.className = 'media-meta';
      
      const type = document.createElement('span');
      type.className = 'media-type';
      type.textContent = file.type;
      
      const size = document.createElement('span');
      size.className = 'media-size';
      size.textContent = formatFileSize(file.size);
      
      meta.appendChild(type);
      meta.appendChild(size);
      info.appendChild(title);
      info.appendChild(meta);
      
      card.appendChild(info);
      
      // Click handler
      card.addEventListener('click', () => openMediaPlayer(file));
      
      elements.mediaGrid.appendChild(card);
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 بايت';
      const k = 1024;
      const sizes = ['بايت', 'ك.ب', 'م.ب', 'ج.ب'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Open media player
    function openMediaPlayer(file) {
      // Close any currently playing media
      if (state.currentlyPlaying) {
        closeMediaPlayer();
      }
      
      state.currentlyPlaying = file.id;
      
      if (file.type === 'image') {
        openImageOverlay(file);
        return;
      } 
      
      if (file.type === 'video') {
        openVideoOverlay(file);
        return;
      } 

      elements.playerTitle.textContent = file.name;
      elements.playerContent.innerHTML = '';
      
      if (file.type === 'audio') {
        const audio = document.createElement('audio');
        audio.src = URL.createObjectURL(file.file);
        audio.controls = true;
        audio.autoplay = true;
        elements.playerContent.appendChild(audio);
      } 
      else if (file.type === 'doc') {
        const iframe = document.createElement('iframe');
        iframe.className = 'doc-viewer';
        iframe.src = URL.createObjectURL(file.file);
        elements.playerContent.appendChild(iframe);
      }
      
      elements.mediaPlayer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // Close media player
    function closeMediaPlayer() {
      elements.mediaPlayer.classList.remove('active');
      document.body.style.overflow = '';
      state.currentlyPlaying = null;
      
      // Clean up
      setTimeout(() => {
        elements.playerContent.innerHTML = '';
      }, 300);
    }

    // Handle scroll for infinite loading
    function handleScroll() {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
        loadMoreItems(elements.searchInput.value);
      }
    }

    // Update UI based on state
    function updateUI() {
      // Update active tab
      Array.from(elements.tabs.children).forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === state.currentTab);
      });
      
      // Update tab badges
      elements.tabBadges.all.textContent = state.counts.all > 0 ? state.counts.all : '';
      elements.tabBadges.image.textContent = state.counts.image > 0 ? state.counts.image : '';
      elements.tabBadges.video.textContent = state.counts.video > 0 ? state.counts.video : '';
      elements.tabBadges.audio.textContent = state.counts.audio > 0 ? state.counts.audio : '';
      elements.tabBadges.doc.textContent = state.counts.doc > 0 ? state.counts.doc : '';
    }

    // Video Overlay Functions
    const videoOverlay = document.getElementById('videoOverlay');
    const overlayVideo = document.getElementById('overlayVideo');
    const videoControls = document.getElementById('videoControls');
    let currentVideoIndex = 0;
    let autoPlayEnabled = false;
    let controlsVisible = true;

    // === التعديل هنا: تحديث طريقة جلب قائمة الفيديوهات ===
    function getVideoElements() {
      const allVideos = state.files.filter(file => file.type === 'video');
      
      // إذا كان التشغيل العشوائي مفعّلاً، قم بخلط (Shuffle) الفيديوهات
      if (state.shuffleEnabled) {
        // نستخدم نسخة مكررة من المصفوفة لتطبيق الترتيب العشوائي
        return shuffleArray([...allVideos]); 
      }
      
      return allVideos; // ارجعها بالترتيب الأصلي إذا كان غير مفعّل
    }

    function openVideoOverlay(file) {
      // === التعديل هنا: يتم تعيين قائمة التشغيل بناءً على حالة الـ Shuffle ===
      state.videoPlayList = getVideoElements();
      currentVideoIndex = state.videoPlayList.findIndex(f => f.id === file.id);
      
      // إذا لم يكن الملف موجودًا في القائمة الجديدة (خاصة بعد الترتيب العشوائي)، قم بتعيين أول فيديو
      if (currentVideoIndex === -1 && state.videoPlayList.length > 0) {
          currentVideoIndex = 0;
      } else if (state.videoPlayList.length === 0) {
          return;
      }
      // ====================================================================

      videoOverlay.style.display = 'block';
      overlayVideo.src = URL.createObjectURL(state.videoPlayList[currentVideoIndex].file);
      overlayVideo.play();
      document.body.style.overflow = 'hidden';
      showControls();
    }

    function closeVideoOverlay() {
      videoOverlay.style.display = 'none';
      overlayVideo.pause();
      overlayVideo.src = '';
      document.body.style.overflow = '';
      // لا نغير حالة التشغيل العشوائي هنا، فقط التشغيل التلقائي
      // autoPlayEnabled = false; 
      updateAutoPlayButton();
    }

    function playNextVideo() {
      // نستخدم state.videoPlayList بدلاً من videoFiles
      currentVideoIndex = (currentVideoIndex + 1) % state.videoPlayList.length;
      playCurrentVideo();
    }

    function playPrevVideo() {
      // نستخدم state.videoPlayList بدلاً من videoFiles
      currentVideoIndex = (currentVideoIndex - 1 + state.videoPlayList.length) % state.videoPlayList.length;
      playCurrentVideo();
    }

    function playCurrentVideo() {
      // نستخدم state.videoPlayList بدلاً من videoFiles
      const file = state.videoPlayList[currentVideoIndex];
      overlayVideo.src = URL.createObjectURL(file.file);
      overlayVideo.play();
    }

    function toggleAutoPlay(event) {
      event.stopPropagation();
      autoPlayEnabled = !autoPlayEnabled;
      updateAutoPlayButton();
    }

    function updateAutoPlayButton() {
      const button = document.querySelector('.autoplay-toggle-btn');
      button.textContent = `التشغيل التلقائي: ${autoPlayEnabled ? 'مفعل' : 'غير مفعل'}`;
    }
    
    // === وظيفة جديدة: التبديل بين التشغيل العشوائي والعادي ===
    function toggleShuffle(event) {
      event.stopPropagation();
      state.shuffleEnabled = !state.shuffleEnabled;
      updateShuffleButton();
      
      // إذا كان الفيديو معروضاً، يجب إعادة تعيين قائمة التشغيل
      if (videoOverlay.style.display === 'block' && state.currentlyPlaying) {
          const currentFile = state.videoPlayList[currentVideoIndex];
          openVideoOverlay(currentFile); // إعادة فتح العارض لإنشاء قائمة تشغيل جديدة
      }
    }
    
    // === وظيفة جديدة: تحديث زر التشغيل العشوائي ===
    function updateShuffleButton() {
      const button = document.querySelector('.shuffle-toggle-btn');
      button.textContent = `الترتيب العشوائي: ${state.shuffleEnabled ? 'مفعل' : 'غير مفعل'}`;
      
      // الترتيب العشوائي يجب أن يكون مفعّلاً عند الإطلاق وفقاً لطلبك
      if (state.shuffleEnabled) {
        button.style.backgroundColor = 'rgba(255, 165, 0, 0.9)'; // لون مميز للعشوائي
        button.style.color = 'black';
      } else {
        button.style.backgroundColor = 'rgba(32, 178, 170, 0.8)';
        button.style.color = 'white';
      }
    }

    function showControls() {
      videoControls.classList.remove('hidden');
      controlsVisible = true;
      hideControlsAfterDelay();
    }

    function hideControls() {
      if (!controlsVisible) return;
      videoControls.classList.add('hidden');
      controlsVisible = false;
    }

    function hideControlsAfterDelay() {
      clearTimeout(videoControls.hideTimeout);
      videoControls.hideTimeout = setTimeout(hideControls, 3000);
    }

    // Event listeners for video controls
    videoOverlay.addEventListener('mousemove', () => {
      if (!controlsVisible) {
        showControls();
      } else {
        hideControlsAfterDelay();
      }
    });

    overlayVideo.addEventListener('ended', () => {
      if (autoPlayEnabled) {
        playNextVideo();
      }
    });

    // Image Overlay Functions
    const imageOverlay = document.getElementById('imageOverlay');
    const overlayImage = document.getElementById('overlayImage');
    
    function openImageOverlay(file) {
      overlayImage.src = URL.createObjectURL(file.file);
      imageOverlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeImageOverlay() {
      imageOverlay.style.display = 'none';
      overlayImage.src = '';
      document.body.style.overflow = '';
    }

    // Initialize the app
    init();
  </script>
</body>
</html>

