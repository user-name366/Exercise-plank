<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/Exercise-plank/manifest.json">
  
  <title>Media Explorer</title>
        <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a0ca3;
      --secondary: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background-color: var(--light);
      color: var(--dark);
      line-height: 1.6;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .folder-input-container {
      position: relative;
    }

    .folder-input-label {
      background-color: rgba(255, 255, 255, 0.9);
      color: var(--primary-dark);
      padding: 0.5rem 1rem;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .folder-input-label:hover {
      background-color: white;
      transform: translateY(-2px);
    }

    #folderInput {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    .tabs-container {
      background-color: white;
      position: sticky;
      top: 68px;
      z-index: 90;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .tabs {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      color: var(--gray);
      transition: var(--transition);
      position: relative;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--secondary);
    }

    .tab:hover {
      color: var(--primary-dark);
      background-color: var(--black);
    }

    .tab-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: var(--secondary);
      color: white; /* تم تعديل اللون ليتوافق مع الخلفية الداكنة */
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .content-container {
      flex: 1;
      /* إزالة الهامش الداخلي الجانبي */
      padding: 1.5rem 0; 
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .media-grid {
      /* عرض عمود واحد على كامل الشاشة */
      display: grid;
      grid-template-columns: 1fr; 
      gap: 1.5rem;
      /* إزالة الهامش الداخلي الجانبي لالتصاق البطاقات بحواف الشاشة */
      padding: 5; 
    }

    /* تم حذف قواعد Media Query للشبكة */

    .media-card {
      background-color: white;
      border-radius: 0px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }

    .media-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .media-thumbnail {
      position: relative;
      width: 100%;
      /* زيادة الارتفاع إلى 70% */
      padding-top: 110%; 
      background-color: var(--light-gray);
      overflow: hidden;
    }

    .media-thumbnail img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-thumbnail video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .audio-thumbnail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #7209b7, #4361ee);
      color: white;
    }

    .doc-thumbnail {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #4cc9f0, #4895ef);
      color: white;
    }

    .media-info {
      padding: 1rem;
      flex: 1;
    }

    .media-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .media-meta {
      display: flex;
      justify-content: space-between;
      color: var(--gray);
      font-size: 0.85rem;
    }

    .media-type {
      text-transform: capitalize;
    }

    .media-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 200;
      transform: translateY(100%);
      transition: var(--transition);
      max-width: 1200px;
      margin: 0 auto;
    }

    .media-player.active {
      transform: translateY(0);
    }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      background-color: var(--primary);
      color: white;
    }

    .player-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .player-content {
      padding: 1rem;
    }

    .player-content video, .player-content audio {
      width: 100%;
      border-radius: 5px;
    }

    .player-content img {
      max-width: 100%;
      max-height: 70vh;
      display: block;
      margin: 0 auto;
      border-radius: 5px;
    }

    .doc-viewer {
      width: 100%;
      height: 70vh;
      border: none;
      background-color: var(--light-gray);
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      padding: 2rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--gray);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--light-gray);
    }

    .empty-title {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .empty-description {
      margin-bottom: 1rem;
    }

      .floating-action-btn {
      position: fixed; bottom: 1.5rem; right: 1.5rem; background-color: var(--secondary); color: white;
      width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); cursor: pointer; z-index: 100; transition: all 0.3s;
    }
    .floating-action-btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5); }

    .alert-message {
      background-color: #fff3cd;
      color: #856404;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem auto;
      max-width: 800px;
      text-align: center;
      border-left: 4px solid #ffeeba;
    }

    /* Styles for video overlay controls */
    .video-controls {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      opacity: 1;
      transition: opacity 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .video-controls.hidden {
      opacity: 0;
    }

    .video-controls button {
      pointer-events: auto;
      margin: 0 5px;
    }

    /* YouTube specific styles */
    #youtube-content {
      display: none;
      flex-direction: column;
      gap: 1rem;
    }

    .youtube-search-bar {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .youtube-search-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .youtube-search-controls input {
      flex: 1;
      padding: 0.8rem 1rem;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 1rem;
    }

    .youtube-search-controls button {
      padding: 0.8rem 1.5rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
    }

    .youtube-search-controls button:hover {
      background-color: var(--primary-dark);
    }
    
    /* YouTube Filters */
    .youtube-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .youtube-filters button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--primary);
        background-color: white;
        color: var(--primary);
        border-radius: 5px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
    }

    .youtube-filters button.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .youtube-filters button:hover:not(.active) {
        background-color: var(--light-gray);
    }

    .youtube-results {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .youtube-card {
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      cursor: pointer;
    }

    .youtube-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .youtube-thumbnail {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      background-color: var(--light-gray);
      overflow: hidden;
    }
    
    .youtube-card[data-type="channel"] .youtube-thumbnail {
        padding-top: 0;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
    }

    .youtube-card[data-type="channel"] .youtube-thumbnail img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid white;
    }

    .youtube-thumbnail img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .youtube-info {
      padding: 1rem;
    }

    .youtube-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.4;
    }
    
    .youtube-type-tag {
        font-size: 0.75rem;
        background-color: var(--secondary);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 5px;
        text-transform: capitalize;
    }

    .youtube-channel {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .load-more-container {
        grid-column: 1 / -1;
        text-align: center;
        padding: 1.5rem 0;
    }

    .load-more-btn {
        padding: 0.75rem 2rem;
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1rem;
        transition: var(--transition);
    }

    .load-more-btn:hover {
        background-color: #d1196e;
        transform: translateY(-2px);
    }

    .load-more-btn:disabled {
        background-color: var(--gray);
        cursor: not-allowed;
    }
    
    /* 🆕 خلفية الفيديو سوداء بالكامل */
    #videoOverlay {
        background: black !important;
    }

    /* 🆕 نمط ملء الشاشة للفيديو داخل طبقة العرض */
    #overlayVideo {
      width: 100vw !important; /* ملء عرض الشاشة بالكامل */
      height: 100vh !important; /* ملء ارتفاع الشاشة بالكامل */
      max-width: 100vw !important;
      max-height: 100vh !important;
      object-fit: contain; /* للحفاظ على نسبة العرض دون قص */
    }
    
    /* 🆕 تحسين سلاسة التمرير لطبقة الفيديو العلوية */
    #videoScroller {
      /* إبقاء overflow-y: scroll لمنع السلوك الافتراضي للمتصفح على اللمس */
      overflow-y: scroll;
      scroll-behavior: smooth; 
      scrollbar-width: none;
      -ms-overflow-style: none;
      
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #videoScroller::-webkit-scrollbar {
      display: none;
    }
    
    /* 🆕 نمط موحد لأزرار التحكم */
    .media-control-btn {
      background-color: #4361eeaa;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s, transform 0.3s;
      margin: 5px;
      pointer-events: auto;
    }
    .media-control-btn:hover {
        background-color: #3a0ca3aa;
        transform: translateY(-2px);
    }
    
    /* 🆕 أزرار التحكم العلوية */
    #topVideoControls {
        position: absolute;
        top: 20px;
        right: 20px;
        left: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        pointer-events: none; /* لتمرير النقرات إلى الفيديو أسفله */
        z-index: 10;
    }

    #topVideoControls > div {
        pointer-events: auto; /* لجعل الحاويات الداخلية قابلة للتفاعل */
        display: flex;
        gap: 10px;
    }
    
    /* 🆕 أزرار التحكم الرئيسية (الإغلاق) */
    #closeVideoBtn {
        background: #ff0000aa;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: auto; 
    }
    
    /* إخفاء controls-wrap عند إخفاء الـ controls */
    .video-controls.hidden #topVideoControls {
        opacity: 0;
    }
    #topVideoControls {
        transition: opacity 0.3s ease;
    }
    
    /* مؤشر السرعة */
    #speedIndicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 2rem;
        font-weight: bold;
        display: none; /* مخفي في البداية */
        pointer-events: none;
    }

  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="header-content">
        <div class="logo">
          <span>📁</span>
          <span>Media Explorer</span>
        </div>
        <div class="folder-input-container">
          <label for="folderInput" class="folder-input-label">
            <span>📂</span>
            <span>Choose Folder</span>
          </label>
          <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>
      </div>
    </header>

    <div class="tabs-container">
      <div class="tabs" id="tabs">
        <div class="tab active" data-type="all">
          <span>🏠 Home</span>
          <span class="tab-badge" id="all-badge"></span>
        </div>
        <div class="tab" data-type="image">
          <span>🖼️ Images</span>
          <span class="tab-badge" id="image-badge"></span>
        </div>
        <div class="tab" data-type="video">
          <span>🎥 Videos</span>
          <span class="tab-badge" id="video-badge"></span>
        </div>
        <div class="tab" data-type="audio">
          <span>🎧 Audio</span>
          <span class="tab-badge" id="audio-badge"></span>
        </div>
        <div class="tab" data-type="doc">
          <span>📄 Documents</span>
          <span class="tab-badge" id="doc-badge"></span>
        </div>
        <div class="tab" data-type="youtube">
          <span>▶️ YouTube</span>
          <span class="tab-badge" id="youtube-badge"></span>
        </div>
      </div>
    </div>
    <div style="margin: 1rem 0;" id="localSearchContainer">
      <input
        type="text"
        id="searchInput"
        placeholder="🔍 ابحث عن ملف بالاسم أو الامتداد..."
        style="width: 100%; padding: 0.8rem 1rem; border: 1px solid #ccc; border-radius: 10px; font-size: 1rem;"
      />
    </div>

    <div class="content-container">
      <div class="alert-message" id="alertMessage">
        ⚠️ من فضلك اختر المجلد من جديد لعرض الملفات
      </div>
      
      <div id="youtube-content" style="display: none;">
          <div class="youtube-search-bar">
              <div class="youtube-filters" id="youtubeFilters">
                  <button data-type="video" class="active">📺 فيديوهات</button>
                  <button data-type="playlist">📑 قوائم تشغيل</button>
                  <button data-type="channel">👤 قنوات</button>
              </div>
              
              <div class="youtube-search-controls">
                  <input type="text" id="youtubeSearchInput" placeholder="🔍 ابحث في يوتيوب..." />
                  <button id="youtubeSearchButton">بحث</button>
              </div>
          </div>
          <div class="youtube-results" id="youtubeResultsGrid">
              </div>
      </div>
      
      <div id="local-content">
          <div class="media-grid" id="mediaGrid"></div>
          <div class="loading-spinner" id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
          </div>
          <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">📁</div>
            <h3 class="empty-title">No Media Files Found</h3>
            <p class="empty-description">Please select a folder containing media files</p>
            <label for="folderInput" class="folder-input-label">
              <span>📂</span>
              <span>Choose Folder</span>
            </label>
          </div>
      </div>
    </div>

    <div class="media-player" id="mediaPlayer">
      <div class="player-header">
        <div class="player-title" id="playerTitle"></div>
        <button class="player-close" id="playerClose">×</button>
      </div>
      <div class="player-content" id="playerContent"></div>
    </div>

    <div class="floating-action-btn" id="scrollToTop" title="Scroll to top" style="display: none;">
      ↑
    </div>
  </div>

  <div id="videoOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:1000;">
    
    <div id="topVideoControls">
        <div>
            <button class="media-control-btn" onclick="toggleShuffle(event)" style="padding: 8px 12px; font-size: 14px;">عشوائي: OFF</button>
            <button class="media-control-btn" onclick="toggleAutoPlay(event)" style="padding: 8px 12px; font-size: 14px;">تلقائي: OFF</button>
        </div>
        <div style="position: relative;">
            <button id="stopTimerBtn" class="media-control-btn" onclick="toggleStopOptions(event)" style="background-color: #00bfa5aa; color: white;">
                ⚙️ إيقاف 
            </button>
            <div id="stopOptionsDropdown" style="
                position: absolute; 
                top: 100%; 
                right: 0; 
                background: rgba(45, 45, 45, 0.95); 
                border-radius: 5px; 
                box-shadow: 0 4px 8px rgba(0,0,0,0.5); 
                padding: 10px; 
                display: none; 
                flex-direction: column; 
                gap: 5px; 
                min-width: 150px;
                z-index: 1000;
            ">
            </div>
        </div>
        <button id="closeVideoBtn" onclick="closeVideoOverlay(event)">✕</button>
    </div>

    <div id="videoScroller" style="position:relative;width:100%;height:100%;">
      
      <div id="currentVideoContainer" style="width:100%;height:100vh;flex-shrink: 0; display:flex;justify-content:center;align-items:center;">
        <video id="overlayVideo" style="width:100%;height:100%;border-radius: 0px;" controls autoplay></video>
        
        <div id="speedIndicator" style="display: none;">2x</div>

        <div class="video-controls" id="videoControls">
          
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="youtubePlayerOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:1001;">
      <div style="position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center;">
          <button onclick="closeYoutubePlayer()" style="position:absolute;top:20px;right:20px;background:#ff0000aa;color:white;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:20px;">✕</button>
          <iframe id="youtubeIframe" width="90%" height="90%" style="border-radius: 10px;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
  </div>

  <script>
      // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // تم استخدام index.html كنطاق (Scope) لتسجيل عامل الخدمة
        navigator.serviceWorker.register('/Exercise-plank/service-worker.js', { scope: '/Exercise-plank/' })
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
    //
    // App State
    const state = {
      files: [],
      currentTab: 'all',
      loadedFiles: new Set(),
      currentlyPlaying: null,
      isLoading: false,
      youtubeSearchType: 'video',
      youtubeNextPageToken: null, 
      counts: {
        all: 0,
        image: 0,
        video: 0,
        audio: 0,
        doc: 0,
        youtube: 0
      }
    };

    // DOM Elements
    const elements = {
      folderInput: document.getElementById('folderInput'),
      tabs: document.getElementById('tabs'),
      mediaGrid: document.getElementById('mediaGrid'),
      loadingSpinner: document.getElementById('loadingSpinner'),
      emptyState: document.getElementById('emptyState'),
      mediaPlayer: document.getElementById('mediaPlayer'),
      playerTitle: document.getElementById('playerTitle'),
      playerContent: document.getElementById('playerContent'),
      playerClose: document.getElementById('playerClose'),
      scrollToTop: document.getElementById('scrollToTop'),
      localContent: document.getElementById('local-content'),
      localSearchContainer: document.getElementById('localSearchContainer'),
      youtubeContent: document.getElementById('youtube-content'),
      youtubeSearchInput: document.getElementById('youtubeSearchInput'),
      youtubeSearchButton: document.getElementById('youtubeSearchButton'),
      youtubeResultsGrid: document.getElementById('youtubeResultsGrid'),
      youtubeFilters: document.getElementById('youtubeFilters'),
      tabBadges: {
        all: document.getElementById('all-badge'),
        image: document.getElementById('image-badge'),
        video: document.getElementById('video-badge'),
        audio: document.getElementById('audio-badge'),
        doc: document.getElementById('doc-badge'),
        youtube: document.getElementById('youtube-badge')
      },
      alertMessage: document.getElementById('alertMessage')
    };

    // Constants
    const BATCH_SIZE = 12;
    // ملاحظة: مفتاح API هذا غير صالح. يجب استبداله بمفتاحك الحقيقي.
    const YOUTUBE_API_KEY = 'AIzaSyBI5_bMERLQgiMHNcQCOHreTT6Kzzu_D2I'; 
    const MAX_YOUTUBE_RESULTS = 50; 

    const SUPPORTED_FORMATS = {
      image: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
      video: ['mp4', 'webm', 'mov', 'avi'],
      audio: ['mp3', 'wav', 'ogg', 'm4a'],
      doc: ['pdf', 'doc', 'docx', 'txt', 'rtf']
    };

    // Initialize the app
    function init() {
      setupEventListeners();
      updateUI();
      showAlertMessage();
    }

    // Event Listeners
    function setupEventListeners() {
      elements.folderInput.addEventListener('change', handleFolderSelection);

      Array.from(elements.tabs.children).forEach(tab => {
        tab.addEventListener('click', () => {
          state.currentTab = tab.dataset.type;
          state.loadedFiles.clear();
          updateUI();
          renderContent();
        });
      });

      document.getElementById('searchInput').addEventListener('input', filterLocalMediaGrid);

      // ربط زر البحث بالوظيفة الأساسية (البحث عن الصفحة الأولى)
      elements.youtubeSearchButton.addEventListener('click', () => {
          executeYoutubeSearch(true); // true لـ resetPage
      });
      elements.youtubeSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
              executeYoutubeSearch(true); // true لـ resetPage
          }
      });
      
      Array.from(elements.youtubeFilters.children).forEach(button => {
          button.addEventListener('click', (e) => {
              const newType = e.target.dataset.type;
              if (newType === state.youtubeSearchType) return;
              
              state.youtubeSearchType = newType;
              updateYoutubeFiltersUI(newType);
              
              const query = elements.youtubeSearchInput.value.trim();
              if (query) {
                  executeYoutubeSearch(true); // true لـ resetPage عند تغيير الفلتر
              }
          });
      });

      window.addEventListener('scroll', handleScroll);
      elements.playerClose.addEventListener('click', closeMediaPlayer);
      elements.scrollToTop.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      window.addEventListener('scroll', () => {
        elements.scrollToTop.style.display = window.scrollY > 300 ? 'flex' : 'none';
      });
    }

    // --- وظائف يوتيوب المُعدَّلة لدعم التصفح اللانهائي ---

    function updateYoutubeFiltersUI(activeType) {
        Array.from(elements.youtubeFilters.children).forEach(button => {
            button.classList.toggle('active', button.dataset.type === activeType);
        });
    }

    function executeYoutubeSearch(resetPage = false) {
        const query = elements.youtubeSearchInput.value.trim();
        
        if (resetPage) {
            state.youtubeNextPageToken = null; // إعادة تعيين المفتاح للبحث الجديد
        }

        const pageToken = resetPage ? null : state.youtubeNextPageToken;

        if (query) {
            searchYoutube(query, state.youtubeSearchType, pageToken, resetPage); 
        } else {
             elements.youtubeResultsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--gray);">الرجاء إدخال كلمة بحث.</div>';
             state.counts.youtube = 0;
             updateUI();
        }
    }

    function renderContent() {
      const isLocalTab = state.currentTab !== 'youtube';
      
      elements.localContent.style.display = isLocalTab ? 'block' : 'none';
      elements.localSearchContainer.style.display = isLocalTab ? 'block' : 'none';
      elements.youtubeContent.style.display = isLocalTab ? 'none' : 'flex';
      
      if (isLocalTab) {
          renderMediaGrid();
      } else {
          updateYoutubeFiltersUI(state.youtubeSearchType);
          
          // عرض النتائج السابقة إذا كانت موجودة، وإلا عرض رسالة البداية
          if (state.counts.youtube === 0) {
              elements.youtubeResultsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--gray);">ابدأ البحث في يوتيوب...</div>';
          }
          // إذا كانت هناك نتائج سابقة، نتركها كما هي ونعرض فقط زر "تحميل المزيد"
          
          updateUI();
      }
    }

    async function searchYoutube(query, type, pageToken, isNewSearch) {
        // إخفاء زر "تحميل المزيد" أثناء التحميل
        const loadMoreBtn = document.getElementById('loadMoreYoutube');
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        
        // عرض مؤشر التحميل. إذا كان بحثاً جديداً، نظهر فقط المؤشر
        if (isNewSearch) {
            elements.youtubeResultsGrid.innerHTML = elements.loadingSpinner.outerHTML;
        } else {
             // إذا كان تحميل المزيد، نستخدم المؤشر الموجود في الـ DOM
             elements.loadingSpinner.style.display = 'flex';
        }
        
        // بناء رابط الـ URL
        let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=${type}&key=${YOUTUBE_API_KEY}&maxResults=${MAX_YOUTUBE_RESULTS}`;
        
        // إضافة مفتاح الصفحة إذا كان متوفراً
        if (pageToken) {
            url += `&pageToken=${pageToken}`;
        }
        
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            // تحديث مفتاح الصفحة التالية
            state.youtubeNextPageToken = data.nextPageToken || null; 

            displayYoutubeResults(data.items, type, isNewSearch);
            elements.loadingSpinner.style.display = 'none';

        } catch (error) {
            console.error('Error fetching YouTube data:', error);
            if (isNewSearch) {
                elements.youtubeResultsGrid.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; color: red;">❌ تعذر تحميل نتائج يوتيوب. تأكد من اتصالك بالإنترنت ومن صحة مفتاح الـ API.</div>`;
            } else {
                 alert('تعذر تحميل المزيد من النتائج.');
            }
            elements.loadingSpinner.style.display = 'none';
            if (isNewSearch) {
               state.counts.youtube = 0;
            }
            updateUI();
        }
    }

    function displayYoutubeResults(items, type, isNewSearch) {
        
        // إذا كان بحثاً جديداً، نبدأ من الصفر
        if (isNewSearch) {
            elements.youtubeResultsGrid.innerHTML = '';
            state.counts.youtube = 0;
        }
        
        // إزالة زر "تحميل المزيد" القديم إن وجد
        const oldLoadMore = document.getElementById('loadMoreContainer');
        if (oldLoadMore) oldLoadMore.remove();


        state.counts.youtube += items.length;

        if (items.length === 0 && isNewSearch) {
            elements.youtubeResultsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--gray);">لا توجد نتائج مطابقة للبحث.</div>';
        }

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'youtube-card';
            card.dataset.type = type;
            
            let id, title, clickHandler;

            if (type === 'video') {
                id = item.id.videoId;
                title = item.snippet.title;
                clickHandler = () => openYoutubePlayer(id, title);
            } else if (type === 'playlist') {
                id = item.id.playlistId;
                title = item.snippet.title;
                // رابط قائمة التشغيل يفتح في نافذة جديدة
                clickHandler = () => window.open(`https://www.youtube.com/playlist?list=${id}`, '_blank');
            } else if (type === 'channel') {
                id = item.id.channelId;
                title = item.snippet.channelTitle;
                // رابط القناة يفتح في نافذة جديدة
                clickHandler = () => window.open(`https://www.youtube.com/channel/${id}`, '_blank');
            }
            
            card.addEventListener('click', clickHandler);


            const thumbnail = document.createElement('div');
            thumbnail.className = 'youtube-thumbnail';
            const img = document.createElement('img');
            
            if (type === 'channel') {
                img.src = item.snippet.thumbnails.default.url;
            } else {
                img.src = item.snippet.thumbnails.medium.url;
            }
            
            img.alt = title;
            thumbnail.appendChild(img);

            const info = document.createElement('div');
            info.className = 'youtube-info';
            
            const titleElement = document.createElement('div');
            titleElement.className = 'youtube-title';
            
            const typeTag = document.createElement('span');
            typeTag.className = 'youtube-type-tag';
            typeTag.textContent = type;
            titleElement.appendChild(typeTag);
            titleElement.appendChild(document.createTextNode(title));
            
            const channel = document.createElement('div');
            channel.className = 'youtube-channel';
            channel.textContent = (type === 'channel') ? item.snippet.description : item.snippet.channelTitle;

            info.appendChild(titleElement);
            info.appendChild(channel);
            card.appendChild(thumbnail);
            card.appendChild(info);
            elements.youtubeResultsGrid.appendChild(card);
        });
        
        // إضافة زر "تحميل المزيد" إذا كان هناك مفتاح للصفحة التالية
        if (state.youtubeNextPageToken) {
            const loadMoreContainer = document.createElement('div');
            loadMoreContainer.className = 'load-more-container';
            loadMoreContainer.id = 'loadMoreContainer';
            
            const loadMoreButton = document.createElement('button');
            loadMoreButton.className = 'load-more-btn';
            loadMoreButton.id = 'loadMoreYoutube';
            loadMoreButton.textContent = 'تحميل المزيد...';
            loadMoreButton.addEventListener('click', () => {
                executeYoutubeSearch(false); // false لعدم إعادة تعيين الصفحة
            });
            
            loadMoreContainer.appendChild(loadMoreButton);
            elements.youtubeResultsGrid.appendChild(loadMoreContainer);
        }

        updateUI();
    }
    
    // (بقية الدوال لم تتغير)
    
    function openYoutubePlayer(videoId, title) {
        const youtubeIframe = document.getElementById('youtubeIframe');
        youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        document.getElementById('youtubePlayerOverlay').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeYoutubePlayer() {
        const youtubeIframe = document.getElementById('youtubeIframe');
        youtubeIframe.src = ''; 
        document.getElementById('youtubePlayerOverlay').style.display = 'none';
        document.body.style.overflow = '';
    }

    function showAlertMessage() {
      elements.alertMessage.style.display = 'block';
      elements.emptyState.style.display = 'none';
      elements.mediaGrid.innerHTML = '';
    }

    function hideAlertMessage() {
      elements.alertMessage.style.display = 'none';
    }

    function handleFolderSelection(event) {
      const newFiles = Array.from(event.target.files)
        .filter(file => isSupportedFile(file.name))
        .map(file => ({
          file,
          id: generateFileId(file),
          type: getFileType(file.name),
          name: file.name,
          size: file.size,
          lastModified: file.lastModified
        }));

      state.files = [...newFiles, ...state.files];
      updateFileCounts();
      
      state.loadedFiles.clear();
      
      hideAlertMessage();
      updateUI();
      renderContent();
    }

    function isSupportedFile(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return Object.values(SUPPORTED_FORMATS).some(formats => formats.includes(ext));
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      
      for (const [type, formats] of Object.entries(SUPPORTED_FORMATS)) {
        if (formats.includes(ext)) {
          return type;
        }
      }
      
      return 'other';
    }

    function generateFileId(file) {
      return `${file.name}-${file.size}-${file.lastModified}`;
    }

    function updateFileCounts() {
      const counts = {
        all: state.files.length,
        image: 0,
        video: 0,
        audio: 0,
        doc: 0,
        youtube: state.counts.youtube
      };

      state.files.forEach(file => {
        if (file.type === 'image') counts.image++;
        if (file.type === 'video') counts.video++;
        if (file.type === 'audio') counts.audio++;
        if (file.type === 'doc') counts.doc++;
      });

      state.counts = counts;
    }

    function getFilteredFiles() {
      if (state.currentTab === 'all') {
        return state.files; 
      }
      return state.files.filter(file => file.type === state.currentTab);
    }

    function renderMediaGrid() {
      elements.mediaGrid.innerHTML = ''; 
      const filteredFiles = getFilteredFiles();
      
      if (filteredFiles.length === 0) {
        elements.emptyState.style.display = 'block';
        return;
      }
      
      elements.emptyState.style.display = 'none';
      loadMoreItems();
    }
    
    function filterLocalMediaGrid(e) {
        const query = e.target.value.toLowerCase();
        const filteredFiles = getFilteredFiles();
        
        const finalFiltered = filteredFiles.filter(file => {
          return (
            file.name.toLowerCase().includes(query) ||
            file.type.toLowerCase().includes(query) ||
            file.name.split('.').pop().toLowerCase().includes(query)
          );
        });
        
        elements.mediaGrid.innerHTML = "";
        finalFiltered.forEach(file => {
          createMediaCard(file); 
        });
        
        elements.loadingSpinner.style.display = 'none';
        elements.emptyState.style.display = finalFiltered.length === 0 ? 'block' : 'none';
    }

    function loadMoreItems() {
      if (state.isLoading) return;
      
      const filteredFiles = getFilteredFiles();
      const loadedIds = Array.from(elements.mediaGrid.children).map(card => card.dataset.id);

      const unloadedFiles = filteredFiles.filter(file => !loadedIds.includes(file.id));
      
      if (unloadedFiles.length === 0) return;
      
      state.isLoading = true;
      elements.loadingSpinner.style.display = 'flex';
      
      setTimeout(() => {
        const batch = unloadedFiles.slice(0, BATCH_SIZE);
        
        batch.forEach(file => {
          createMediaCard(file);
        });
        
        state.isLoading = false;
        elements.loadingSpinner.style.display = 'none';
      }, 300);
    }

    function createMediaCard(file) {
      const card = document.createElement('div');
      card.className = 'media-card';
      card.dataset.id = file.id;
      
      const thumbnail = document.createElement('div');
      thumbnail.className = 'media-thumbnail';
      
      if (file.type === 'image') {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file.file);
        img.alt = file.name;
        img.loading = 'lazy';
        thumbnail.appendChild(img);
      } 
      else if (file.type === 'video') {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file.file);
        video.muted = true;
        video.loop = true;
        video.playsInline = true;
        thumbnail.appendChild(video);
      } 
      else if (file.type === 'audio') {
        const audioThumb = document.createElement('div');
        audioThumb.className = 'audio-thumbnail';
        audioThumb.innerHTML = '🎵';
        thumbnail.appendChild(audioThumb);
      } 
      else if (file.type === 'doc') {
        const docThumb = document.createElement('div');
        docThumb.className = 'doc-thumbnail';
        
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext === 'pdf') docThumb.innerHTML = '📄';
        else if (ext === 'doc' || ext === 'docx') docThumb.innerHTML = '📝';
        else docThumb.innerHTML = '📋';
        
        thumbnail.appendChild(docThumb);
      }
      
      const info = document.createElement('div');
      info.className = 'media-info';
      
      const title = document.createElement('div');
      title.className = 'media-title';
      title.textContent = file.name;
      
      const meta = document.createElement('div');
      meta.className = 'media-meta';
      
      const type = document.createElement('span');
      type.className = 'media-type';
      type.textContent = file.type;
      
      const size = document.createElement('span');
      size.className = 'media-size';
      size.textContent = formatFileSize(file.size);
      
      meta.appendChild(type);
      meta.appendChild(size);
      info.appendChild(title);
      info.appendChild(meta);
      
      card.appendChild(thumbnail);
      card.appendChild(info);
      
      card.addEventListener('click', () => openMediaPlayer(file));
      
      elements.mediaGrid.appendChild(card);
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function openMediaPlayer(file) {
      if (state.currentlyPlaying) {
        closeMediaPlayer();
      }
      
      state.currentlyPlaying = file.id;
      elements.playerTitle.textContent = file.name;
      elements.playerContent.innerHTML = '';
      
      if (file.type === 'image') {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file.file);
        img.alt = file.name;
        elements.playerContent.appendChild(img);
      } 
      else if (file.type === 'video') {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(file.file);
        video.controls = true;
        video.autoplay = true;
        elements.playerContent.appendChild(video);
      } 
      else if (file.type === 'audio') {
        const audio = document.createElement('audio');
        audio.src = URL.createObjectURL(file.file);
        audio.controls = true;
        audio.autoplay = true;
        elements.playerContent.appendChild(audio);
      } 
      else if (file.type === 'doc') {
        const iframe = document.createElement('iframe');
        iframe.className = 'doc-viewer';
        iframe.src = URL.createObjectURL(file.file);
        elements.playerContent.appendChild(iframe);
      }
      
      elements.mediaPlayer.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMediaPlayer() {
      elements.mediaPlayer.classList.remove('active');
      document.body.style.overflow = '';
      state.currentlyPlaying = null;
      
      setTimeout(() => {
        elements.playerContent.innerHTML = '';
      }, 300);
    }

    function handleScroll() {
        if (state.currentTab !== 'youtube') {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                loadMoreItems();
            }
        }
    }

    function updateUI() {
      Array.from(elements.tabs.children).forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === state.currentTab);
      });
      
      elements.tabBadges.all.textContent = state.counts.all > 0 ? state.counts.all : '';
      elements.tabBadges.image.textContent = state.counts.image > 0 ? state.counts.image : '';
      elements.tabBadges.video.textContent = state.counts.video > 0 ? state.counts.video : '';
      elements.tabBadges.audio.textContent = state.counts.audio > 0 ? state.counts.audio : '';
      elements.tabBadges.doc.textContent = state.counts.doc > 0 ? state.counts.doc : '';
      elements.tabBadges.youtube.textContent = state.counts.youtube > 0 ? state.counts.youtube : '';
    }
    
    // --- وظائف مشغل الفيديو (Video Overlay) مع التشغيل العشوائي والتمرير الجديد ---

    const overlay = document.getElementById('videoOverlay');
    const overlayVideo = document.getElementById('overlayVideo');
    const videoControls = document.getElementById('videoControls'); 
    const closeVideoBtn = document.getElementById('closeVideoBtn');
    const topVideoControls = document.getElementById('topVideoControls'); 
    const videoScroller = document.getElementById('videoScroller');
    const speedIndicator = document.getElementById('speedIndicator'); // 🆕 عنصر مؤشر السرعة
    
    let touchStartY = 0; 
    let isSwiping = false; 

    let currentVideoIndex = 0;
    let videoFiles = [];
    let shuffledIndices = [];
    let shuffleEnabled = false;
    let autoPlayEnabled = false;
    let controlsVisible = true;
    let isLongPressing = false; // 🆕 حالة الضغط المطول

    // 🆕 متغيرات مؤقت الإيقاف
    let stopAfterCount = 0; // 0 يعني لا يوجد مؤقت، 1 يعني المقطع الحالي، 2 يعني بعد مقطع، وهكذا
    const maxStopCount = 10; // الحد الأقصى لعدد الفيديوهات المسموح به

    function getVideoElements() {
      return state.files.filter(file => file.type === 'video');
    }

    function generateShuffleOrder(length) {
      const indices = Array.from({ length }, (_, i) => i);
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      return indices;
    }

    function toggleShuffle(event) {
        event.stopPropagation();
        shuffleEnabled = !shuffleEnabled;
        updateShuffleButton();
        
        videoFiles = getVideoElements();
        if (videoFiles.length === 0) return;

        if (shuffleEnabled) {
            shuffledIndices = generateShuffleOrder(videoFiles.length);
            const currentFileIndex = videoFiles.findIndex(file => file.id === state.currentlyPlaying);
            
            const currentShuffleIndex = shuffledIndices.findIndex(index => index === currentFileIndex);
            if (currentShuffleIndex !== -1) {
                // نقل الفيديو الحالي إلى بداية قائمة الترتيب العشوائي
                [shuffledIndices[0], shuffledIndices[currentShuffleIndex]] = [shuffledIndices[currentShuffleIndex], shuffledIndices[0]];
            }
            currentVideoIndex = 0;
            loadCurrentVideo();
        } else {
            // العودة إلى الترتيب الأصلي والبحث عن الفيديو الحالي
            if (state.currentlyPlaying) {
                currentVideoIndex = videoFiles.findIndex(file => file.id === state.currentlyPlaying);
            } else {
                currentVideoIndex = 0;
            }
             loadCurrentVideo(); 
        }
    }

    function updateShuffleButton() {
        const button = document.querySelector('#topVideoControls button[onclick="toggleShuffle(event)"]');
        if (button) {
            button.textContent = `عشوائي: ${shuffleEnabled ? 'ON' : 'OFF'}`;
            button.style.backgroundColor = shuffleEnabled ? '#f72585aa' : '#4361eeaa';
        }
    }
    
    // 🆕 وظيفة عرض/إخفاء القائمة المنسدلة لخيارات الإيقاف
    function toggleStopOptions(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('stopOptionsDropdown');
        dropdown.style.display = dropdown.style.display === 'flex' ? 'none' : 'flex';
        if (dropdown.style.display === 'flex') {
            renderStopOptions();
        }
    }

    // 🆕 وظيفة لملء القائمة المنسدلة بخيارات الإيقاف
    function renderStopOptions() {
        const dropdown = document.getElementById('stopOptionsDropdown');
        const totalVideos = videoFiles.length;
        dropdown.innerHTML = '';
        
        // 1. خيار إيقاف المؤقت (لا شيء)
        createOption(dropdown, 'إيقاف المؤقت', 0);
        
        // 2. خيار المقطع الحالي
        createOption(dropdown, 'إيقاف بعد المقطع الحالي', 1);

        // 3. خيارات عدد الفيديوهات (من 2 إلى 10)
        // نحسب الفيديوهات المتبقية في القائمة الأصلية
        const currentFileIndex = videoFiles.findIndex(file => file.id === state.currentlyPlaying);
        const remainingVideos = totalVideos - currentFileIndex;
        
        // الحد الأقصى للعد هو إما 10 أو إجمالي الفيديوهات المتبقية (أيهما أقل)
        const maxCount = Math.min(maxStopCount, remainingVideos - 1); 
        
        for (let i = 2; i <= maxCount; i++) {
            createOption(dropdown, `إيقاف بعد ${i} مقاطع`, i);
        }
        
        // 4. خيار لآخر القائمة (إذا كان هناك أكثر من 10 فيديوهات متبقية)
        if (remainingVideos > maxStopCount) {
             createOption(dropdown, `إيقاف بعد آخر مقطع (${remainingVideos} مقطع)`, remainingVideos);
        } else if (remainingVideos > 1) {
            // في حالة كان عدد الفيديوهات المتبقية قليل، ولكن لم نصل لآخر القائمة بعد
            createOption(dropdown, `إيقاف بعد آخر مقطع (${remainingVideos} مقطع)`, remainingVideos);
        }
    }

    // 🆕 دالة مساعدة لإنشاء خيار
    function createOption(dropdown, text, count) {
        const option = document.createElement('button');
        option.textContent = text;
        option.classList.add('media-control-btn');
        // إذا كانت هذه هي القيمة المحددة حاليًا، أضف نمطًا مختلفًا
        if (stopAfterCount === count) {
            option.style.backgroundColor = '#2ecc71aa'; // لون أخضر للإشارة إلى التفعيل
        } else {
            option.style.backgroundColor = '#7f8c8daa'; // لون رمادي للخيار غير المفعل
        }
        option.style.padding = '5px 10px';
        option.style.fontSize = '12px';
        option.style.justifyContent = 'flex-start'; // محاذاة النص لليسار
        
        option.onclick = (e) => setStopTimer(e, count, text);
        dropdown.appendChild(option);
    }
    
    // 🆕 وظيفة تعيين مؤقت الإيقاف
    function setStopTimer(event, count, text) {
        event.stopPropagation();
        stopAfterCount = count;
        
        const stopTimerBtn = document.getElementById('stopTimerBtn');
        
        if (stopAfterCount === 0) {
            stopTimerBtn.innerHTML = '⚙️ إيقاف';
            stopTimerBtn.style.backgroundColor = '#00bfa5aa';
            alert('تم إلغاء مؤقت الإيقاف التلقائي.');
        } else {
            // نحتاج لحساب عدد المقاطع المتبقية فعلياً بناءً على الخيار
            let alertText = text;
            if (count === 1) {
                alertText = 'المقطع الحالي';
            } else if (count > 1) {
                alertText = `${count} مقاطع`;
            }
            
            stopTimerBtn.innerHTML = `⏳ ${alertText}`;
            stopTimerBtn.style.backgroundColor = '#e67e22aa'; // لون برتقالي للإشارة إلى تفعيل المؤقت
            alert(`تم تعيين مؤقت الإيقاف التلقائي: ${alertText}`);
        }
        
        // إغلاق القائمة المنسدلة
        document.getElementById('stopOptionsDropdown').style.display = 'none';
        
        // نضمن تحديث خيارات التظليل عند إعادة فتح القائمة
        renderStopOptions();
    }


    // ------------------------------------------------------------------
    // | 🆕 وظائف ميزة الضغط المطول لتسريع الفيديو إلى 2x (مثل يوتيوب) |
    // ------------------------------------------------------------------

    function speedUpVideo() {
        // نتحقق من أن الفيديو ليس متوقفًا مؤقتًا
        if (!overlayVideo.paused) {
            overlayVideo.playbackRate = 2.0; // تسريع التشغيل لضعف السرعة
            isLongPressing = true;
            
            // عرض مؤشر السرعة
            speedIndicator.textContent = '2x';
            speedIndicator.style.display = 'block';
        }
    }

    function resetVideoSpeed() {
        if (isLongPressing) {
            overlayVideo.playbackRate = 1.0; // إعادة السرعة إلى الوضع الطبيعي
            isLongPressing = false;
            
            // إخفاء مؤشر السرعة
            speedIndicator.style.display = 'none';
        }
    }

    function openVideoOverlay(videoCard) {
      const fileId = videoCard.dataset.id;
      videoFiles = getVideoElements();
      
      shuffleEnabled = false;
      updateShuffleButton(); 

      currentVideoIndex = videoFiles.findIndex(file => file.id === fileId);
      if (currentVideoIndex === -1) return;
      state.currentlyPlaying = fileId;
      
      // 🆕 إعادة تعيين المؤقت وزر الواجهة عند فتح مشغل جديد
      stopAfterCount = 0; 
      const stopTimerBtn = document.getElementById('stopTimerBtn');
      if (stopTimerBtn) {
          stopTimerBtn.innerHTML = '⚙️ إيقاف';
          stopTimerBtn.style.backgroundColor = '#00bfa5aa';
      }

      overlay.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      loadCurrentVideo(true); 
      
      // 🆕 إضافة مستمعات الضغط المطول (لـ 2x)
      // لأجهزة الكمبيوتر (الماوس)
      overlayVideo.addEventListener('mousedown', speedUpVideo); 
      overlayVideo.addEventListener('mouseup', resetVideoSpeed);
      
      // للأجهزة التي تعمل باللمس (الموبايل)
      overlayVideo.addEventListener('touchstart', speedUpVideo, { passive: true });
      overlayVideo.addEventListener('touchend', resetVideoSpeed, { passive: false });
      
      // منع ظهور قائمة السياق عند الضغط المطول بالماوس
      overlayVideo.addEventListener('contextmenu', (e) => {
          if (isLongPressing) {
              e.preventDefault();
          }
      });
      
      // 🆕 إضافة مستمع اللمس (touch) للجوالات
      overlay.addEventListener('touchstart', handleTouchStart, { passive: true });
      overlay.addEventListener('touchend', handleTouchEnd, { passive: false });
      
      showControls();
    }

    // *** دالة الإغلاق المصححة لضمان عدم تداخل الأحداث ***
    function closeVideoOverlay(e) {
      // إيقاف نشر الحدث إلى العناصر الأب (Overlay) لحل مشكلة الإغلاق
      if (e) {
          e.stopPropagation(); 
          e.preventDefault(); 
      }
      
      if (document.fullscreenElement) {
        document.exitFullscreen();
      }
      if (document.pictureInPictureElement) {
        document.exitPictureInPicture();
      }

      overlay.style.display = 'none';
      overlayVideo.pause();
      overlayVideo.src = '';
      document.body.style.overflow = '';
      autoPlayEnabled = false;
      shuffleEnabled = false;
      
      // 🆕 إعادة تعيين مؤقت الإيقاف
      stopAfterCount = 0; 
      const stopTimerBtn = document.getElementById('stopTimerBtn');
      if (stopTimerBtn) {
          stopTimerBtn.innerHTML = '⚙️';
          stopTimerBtn.style.backgroundColor = '#00bfa5aa';
      }
      
      updateAutoPlayButton();
      updateShuffleButton();
      state.currentlyPlaying = null;
      
      // 🆕 إزالة مستمعات اللمس والضغط المطول عند الإغلاق
      overlay.removeEventListener('touchstart', handleTouchStart, { passive: true });
      overlay.removeEventListener('touchend', handleTouchEnd, { passive: false });
      overlayVideo.removeEventListener('mousedown', speedUpVideo); 
      overlayVideo.removeEventListener('mouseup', resetVideoSpeed);
      overlayVideo.removeEventListener('touchstart', speedUpVideo, { passive: true });
      overlayVideo.removeEventListener('touchend', resetVideoSpeed, { passive: false });
      overlayVideo.removeEventListener('contextmenu', e => e.preventDefault());
      speedIndicator.style.display = 'none'; // إخفاء مؤشر السرعة
      
      clearTimeout(window.controlsTimeout);
    }

    function playNextVideo() {
      if (videoFiles.length === 0) return;
      
      if (!shuffleEnabled && currentVideoIndex === videoFiles.length - 1) {
          // إذا كان الفيديو الأخير، لا تفعل شيئاً
          return;
      }

      currentVideoIndex = (currentVideoIndex + 1) % videoFiles.length;
      loadCurrentVideo();
    }

    function playPrevVideo() {
      if (videoFiles.length === 0) return;
      
      if (!shuffleEnabled && currentVideoIndex === 0) {
          // إذا كان الفيديو الأول، لا تفعل شيئاً
          return;
      }

      currentVideoIndex = (currentVideoIndex - 1 + videoFiles.length) % videoFiles.length;
      loadCurrentVideo();
    }

    function loadCurrentVideo(isInitialLoad = false) { 
      if (videoFiles.length === 0) return;
      
      let file;
      if (shuffleEnabled) {
        const realIndex = shuffledIndices[currentVideoIndex];
        file = videoFiles[realIndex];
      } else {
        file = videoFiles[currentVideoIndex];
      }
      
      state.currentlyPlaying = file.id;
      
      overlayVideo.src = URL.createObjectURL(file.file);
      overlayVideo.play().then(() => {
        if (autoPlayEnabled) {
          overlayVideo.play();
        }
      }).catch(e => console.log('Autoplay prevented:', e));
      
      // التمركز: بما أن هناك فيديو واحد فقط، دائمًا ما يكون الموضع 0
      if (videoScroller) {
          videoScroller.scrollTo({ 
              top: 0, 
              behavior: 'auto' 
          });
      }
      
      // إعادة تعيين السرعة عند تحميل فيديو جديد (احتياطي)
      overlayVideo.playbackRate = 1.0; 
      isLongPressing = false; 
    }

    function toggleAutoPlay(event) {
      event.stopPropagation();
      autoPlayEnabled = !autoPlayEnabled;
      updateAutoPlayButton();
      
      if (autoPlayEnabled && overlayVideo.paused) {
        overlayVideo.play();
      }
    }

    function updateAutoPlayButton() {
        const button = document.querySelector('#topVideoControls button[onclick="toggleAutoPlay(event)"]');
        if (button) {
            button.textContent = `تلقائي: ${autoPlayEnabled ? 'ON' : 'OFF'}`;
            button.style.backgroundColor = autoPlayEnabled ? '#f72585aa' : '#4361eeaa';
        }
    }

    function toggleControls() {
      controlsVisible = !controlsVisible;
      if (controlsVisible) {
        videoControls.classList.remove('hidden');
        topVideoControls.classList.remove('hidden');
      } else {
        videoControls.classList.add('hidden');
        topVideoControls.classList.add('hidden');
      }
      
      // إعادة ضبط المؤقت
      showControls();
    }

    function showControls() {
      controlsVisible = true;
      videoControls.classList.remove('hidden');
      topVideoControls.classList.remove('hidden');
      
      clearTimeout(window.controlsTimeout);
      window.controlsTimeout = setTimeout(() => {
        if (!overlayVideo.paused && !isLongPressing) { // 🆕 لا تخفِ التحكمات إذا كان الضغط المطول مفعلاً
          controlsVisible = false;
          videoControls.classList.add('hidden');
          topVideoControls.classList.add('hidden');
        }
      }, 3000);
    }
    
    // *** وظائف معالجة اللمس (Touch Handling) المحسّنة ***
    function handleTouchStart(e) {
        if (e.touches.length === 1) {
            touchStartY = e.touches[0].clientY;
            isSwiping = false;
        }
    }

    function handleTouchEnd(e) {
        if (e.changedTouches.length === 1 && videoFiles.length > 1) {
            const touchEndY = e.changedTouches[0].clientY;
            const deltaY = touchEndY - touchStartY;
            const SWIPE_THRESHOLD = 50; // حد المسافة للتمرير (Flick)
            
            // تحقق من حركة السحب القوية (Flick)
            // 🆕 أضفنا شرط عدم تفعيل الضغط المطول لتجنب تعارض الأحداث
            if (Math.abs(deltaY) > SWIPE_THRESHOLD && !isSwiping && !isLongPressing) { 
                isSwiping = true;
                
                // منع التمرير الافتراضي للمتصفح (Scroll)
                e.preventDefault(); 
                
                if (deltaY < 0) {
                    // السحب للأعلى (End Y < Start Y): الفيديو التالي
                    playNextVideo();
                } else {
                    // السحب للأسفل (End Y > Start Y): الفيديو السابق
                    playPrevVideo();
                }
                
                // إعادة ضبط حالة السحب بعد فترة قصيرة للسماح بسحبة جديدة
                setTimeout(() => { isSwiping = false; }, 500); 
            }
        }
    }

    // *** مستمع النقر على الـ Overlay للتحكم بالواجهة ***
    overlay.addEventListener('click', (e) => {
      // نتحقق مما إذا كان الهدف هو عنصر تحكم (زر أو منطقة تحكم)
      if (!e.target.closest('#topVideoControls')) {
          toggleControls();
      }
    });

    overlayVideo.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleControls();
    });

    overlayVideo.addEventListener('play', () => {
      showControls();
    });
    
    overlayVideo.addEventListener('pause', () => {
        showControls();
        clearTimeout(window.controlsTimeout);
    });

    overlayVideo.addEventListener('ended', () => {
      // 🆕 منطق مؤقت الإيقاف
      if (stopAfterCount > 0) {
          stopAfterCount--;
          if (stopAfterCount === 0) {
              // المؤقت وصل للصفر، أوقف التشغيل وأغلق الـ Overlay
              alert('تم الوصول إلى عدد المقاطع المحددة. إيقاف التشغيل التلقائي.');
              closeVideoOverlay(); 
              return; // أوقف تنفيذ باقي الدالة
          } else {
              // المؤقت لم يصل للصفر بعد، فقط حدث نص الزر
              const stopTimerBtn = document.getElementById('stopTimerBtn');
              let remainingText = '';
              if (stopAfterCount === 1) {
                  remainingText = 'مقطع واحد متبقٍ';
              } else {
                  remainingText = `${stopAfterCount} مقاطع متبقية`;
              }
              stopTimerBtn.innerHTML = `⏳ ${remainingText}`;
              // تحديث الخيارات المنسدلة لإظهار القيمة الجديدة
              renderStopOptions(); 
          }
      }
      
      // المنطق الأصلي (تشغيل التالي إذا كان التلقائي مفعلاً)
      if (autoPlayEnabled) {
        playNextVideo();
      } else {
        showControls();
      }
    });

    const originalOpenMediaPlayer = window.openMediaPlayer;
    window.openMediaPlayer = function(file) {
      if (file.type === 'video') {
        const videoCard = document.querySelector(`.media-card[data-id="${file.id}"]`);
        if (videoCard) openVideoOverlay(videoCard);
      } else {
        originalOpenMediaPlayer(file);
      }
    };

    // قم بتعريض الدوال المطلوبة عالمياً لاستخدامها في onclick بالـ HTML
    window.closeVideoOverlay = closeVideoOverlay; 
    window.toggleStopOptions = toggleStopOptions; // 🆕
    window.setStopTimer = setStopTimer; // 🆕
    window.toggleShuffle = toggleShuffle; // 🆕
    window.toggleAutoPlay = toggleAutoPlay; // 🆕

    // Initialize the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
